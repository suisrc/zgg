name: 'Build Image Logic'
description: 'Build image steps for jobs'

# inputs:
#   var_appname:
#     description: 'Name of the variable'
#     required: true

# env:
#   IMAGE_NAME: suisrc/k8skit
#   GITHUB_REGISTRY: ghcr.io
#   DOCKER_REGISTRY: docker.io
#   IMAGE_VERSION: "`cat app/version`-`cat app/vname`"

runs:
  using: 'composite'
  steps:
    - name: Build image
      shell: bash
      run: |
        echo "appname: `cat app/vname`, version: `cat app/version`"
        make `cat app/vname`2 && docker build -t image --no-cache .
    - name: Push github image
      shell: bash
      run: |
        REGISTRY_URL=$GITHUB_REGISTRY
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login $REGISTRY_URL -u ${{ github.actor }} --password-stdin
        IMAGE_ID=$REGISTRY_URL/$GITHUB_REPOSITORY
        echo IMAGE_ID=$IMAGE_ID
        VERSION=$IMAGE_VERSION
        echo VERSION=$VERSION
        docker tag image $IMAGE_ID:$VERSION
        docker push $IMAGE_ID:$VERSION
    - name: Push docker image
      shell: bash
      run: |
        REGISTRY_URL=$DOCKER_REGISTRY
        echo "${{ secrets.DOCKER_TOKEN }}" | docker login $REGISTRY_URL -u ${{ secrets.DOCKER_USER }} --password-stdin
        IMAGE_ID=$REGISTRY_URL/$IMAGE_NAME
        echo IMAGE_ID=$IMAGE_ID
        VERSION=$IMAGE_VERSION
        echo VERSION=$VERSION
        docker tag image $IMAGE_ID:$VERSION
        docker push $IMAGE_ID:$VERSION
